<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Discovery Hike | Voucher System</title>
      <link rel="icon" href="favicon.ico">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="googlebot" content="noindex, nofollow">
<meta name="robots" content="noindex, nofollow">
<meta http-equiv="Cache-Control" content="no-store">


<style>

  body {
  visibility: hidden;
}

/* ================= THEME VARIABLES ================= */
:root {
  --primary: #00254d;
  --accent: #004b99;
  --danger: #c62828;

  --bg: #f4f6f8;
  --card: #ffffff;
  --text: #333;
  --muted: #666;

  --tile-title-light: #00254d;
  --tile-title-dark: #f1f5f9;
}

/* DARK MODE */
body.dark {
  --bg: #0f172a;
  --card: #111827;
  --text: #e5e7eb;
  --muted: #9ca3af;
}

/* ================= BASE ================= */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
               Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background 0.3s ease, color 0.3s ease;
}

.container {
  max-width: 820px;
  margin: auto;
  padding: 18px;
}

/* ================= HEADER ================= */
.header-gradient {
  background: linear-gradient(135deg, #00254d, #004b99);
  padding: 28px 18px 30px;
  border-radius: 18px;
  text-align: center;
  margin-bottom: 26px;
  box-shadow: 0 10px 24px rgba(0,0,0,0.18);
  animation: fadeDown 0.6s ease;
  position: relative; /* REQUIRED for logout button */
}

.header-gradient img {
  width: 160px;
  max-width: 70%;
  margin: 0 auto 10px;
  display: block;
}

.header-gradient h1 {
  color: #ffffff;
  font-size: 20px;
  margin: 6px 0 4px;
}

.header-gradient p {
  color: #d0e4ff;
  font-size: 13px;
  margin: 0;
  letter-spacing: 0.4px;
}

/* ================= LOGOUT BUTTON (NEW) ================= */
.logout-btn {
  position: absolute;
  top: 14px;
  left: 14px;
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.35);
  color: #ffffff;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 12px;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.1s ease;
}

.logout-btn:hover {
  background: rgba(255,255,255,0.25);
}

.logout-btn:active {
  transform: scale(0.96);
}

/* ================= DARK MODE TOGGLE ================= */
.toggle {
  position: fixed;
  top: 14px;
  right: 14px;
  background: var(--card);
  border-radius: 50px;
  padding: 6px 12px;
  font-size: 12px;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  z-index: 10;
}

/* ================= SECTION ================= */
.section {
  margin-top: 22px;
  animation: fadeUp 0.5s ease;
}

.section-title {
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 12px;
  letter-spacing: 0.5px;
}

/* ================= GRID ================= */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 14px;
}

/* ================= TILE ================= */
.tile {
  background: var(--card);
  border-radius: 14px;
  padding: 18px 14px;
  text-align: center;
  text-decoration: none;
  color: var(--primary);
  box-shadow: 0 6px 14px rgba(0,0,0,0.08);
  transition: transform 0.18s ease, box-shadow 0.18s ease;
  -webkit-tap-highlight-color: transparent;
}

.tile:hover {
  transform: translateY(-4px);
  box-shadow: 0 14px 24px rgba(0,0,0,0.18);
}

/* DARK MODE DESKTOP GLOW */
@media (hover: hover) {
  body.dark .tile:hover {
    box-shadow:
      0 0 0 1px rgba(56, 189, 248, 0.25),
      0 16px 28px rgba(0,0,0,0.6);
  }
}

/* MOBILE VISIBILITY FIX */
@media (hover: none) {
  .tile {
    opacity: 1 !important;
    transform: none !important;
    box-shadow: 0 8px 18px rgba(0,0,0,0.25) !important;
  }

  body.dark .tile {
    box-shadow: 0 8px 18px rgba(0,0,0,0.45) !important;
  }

  .tile:active {
    transform: scale(0.97);
    box-shadow: 0 6px 12px rgba(0,0,0,0.35);
    transition: transform 0.08s ease, box-shadow 0.08s ease;
  }

  body.dark .tile:active {
    box-shadow: 0 6px 12px rgba(0,0,0,0.6);
  }
}

.tile-icon {
  font-size: 26px;
  margin-bottom: 10px;
}

.tile-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--tile-title-light);
}

body.dark .tile-title {
  color: var(--tile-title-dark);
}

.tile-desc {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
  line-height: 1.4;
}

/* ================= TAGS ================= */
.tag {
  display: inline-block;
  margin-top: 10px;
  font-size: 11px;
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 600;
}

.safe {
  background: #e3f2fd;
  color: #0d47a1;
}

.restricted {
  background: #fdecea;
  color: var(--danger);
}

body.dark .safe {
  background: rgba(34, 211, 238, 0.15);
  color: #67e8f9;
}

body.dark .restricted {
  background: rgba(239, 68, 68, 0.18);
  color: #fca5a5;
}

/* ================= FOOTER ================= */
.footer {
  margin-top: 40px;
  padding: 18px;
  text-align: center;
  font-size: 12px;
  color: #d0e4ff;
  background: linear-gradient(135deg, #00254d, #004b99);
  border-radius: 14px;
  animation: fadeUp 0.6s ease;
}

/* ================= ANIMATIONS ================= */
@keyframes fadeDown {
  from { opacity: 0; transform: translateY(-12px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
/* ===== FOOTER SESSION BAR ===== */
.session-bar {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 14px;
  font-size: 12px;
}

.logout-footer-btn {
  background: rgba(255,255,255,0.18);
  border: 1px solid rgba(255,255,255,0.35);
  color: #ffffff;
  padding: 6px 14px;
  border-radius: 999px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.logout-footer-btn:hover {
  background: rgba(255,255,255,0.28);
}

.logout-footer-btn:active {
  transform: scale(0.96);
}

/* Loading state */
.logout-footer-btn.loading {
  pointer-events: none;
  opacity: 0.85;
}

/* Spinner */
.logout-footer-btn.loading::after {
  content: " ‚è≥";
}
/* ================= VOUCHER PREMIUM STYLES ================= */

.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px,1fr));
  gap: 14px;
  margin-bottom: 22px;
}

.kpi-card {
  background: var(--card);
  border-radius: 16px;
  padding: 18px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.kpi-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 18px 35px rgba(0,0,0,0.18);
}

.kpi-title {
  font-size: 12px;
  text-transform: uppercase;
  color: var(--muted);
  letter-spacing: 0.6px;
}

.kpi-value {
  font-size: 26px;
  font-weight: 700;
  margin-top: 6px;
}

/* Tabs */
.voucher-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 18px;
  flex-wrap: wrap;
}

.voucher-tab {
  padding: 8px 16px;
  border-radius: 999px;
  background: var(--card);
  cursor: pointer;
  font-size: 13px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  transition: all 0.2s ease;
}

.voucher-tab.active {
  background: linear-gradient(135deg, #00254d, #004b99);
  color: #fff;
  box-shadow: 0 8px 20px rgba(0,75,153,0.4);
}

.voucher-tab:hover {
  transform: translateY(-2px);
}

.voucher-panel {
  background: var(--card);
  border-radius: 16px;
  padding: 22px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.08);
  animation: fadeUp 0.4s ease;
}

.hidden {
  display: none !important;
}


/* ================= PREMIUM FORM ================= */

.voucher-form {
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.form-row {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
}

.form-group {
  position: relative;
  flex: 1;
  min-width: 180px;
}

.form-group input,
.form-group textarea {
  width: 100%;
  padding: 14px 12px 14px 12px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  background: var(--card);
  color: var(--text);
  font-size: 14px;
  outline: none;
  transition: all 0.2s ease;
}

body.dark .form-group input,
body.dark .form-group textarea {
  border: 1px solid #374151;
}

.form-group input:focus,
.form-group textarea:focus {
  border-color: #004b99;
  box-shadow: 0 0 0 2px rgba(0,75,153,0.2);
}

.form-group label {
  position: absolute;
  left: 12px;
  top: 14px;
  font-size: 13px;
  color: var(--muted);
  pointer-events: none;
  transition: all 0.2s ease;
  background: var(--card);
  padding: 0 4px;
}

.form-group input:focus + label,
.form-group input:not(:placeholder-shown) + label,
.form-group textarea:focus + label,
.form-group textarea:not(:placeholder-shown) + label {
  top: -8px;
  font-size: 11px;
  color: #004b99;
}

/* Button */
.primary-btn {
  padding: 12px 18px;
  border-radius: 10px;
  border: none;
  background: linear-gradient(135deg, #00254d, #004b99);
  color: #fff;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.25s ease;
}

.primary-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(0,75,153,0.4);
}

.primary-btn.loading {
  opacity: 0.8;
  pointer-events: none;
}

/* Result Box */
.result-box {
  margin-top: 18px;
  padding: 14px;
  border-radius: 10px;
  font-size: 14px;
  background: rgba(22,163,74,0.12);
  color: #15803d;
}

body.dark .result-box {
  background: rgba(34,197,94,0.15);
}
/* Toast */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(135deg,#00254d,#004b99);
  color: white;
  padding: 14px 18px;
  border-radius: 10px;
  font-size: 13px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.25);
  z-index: 9999;
  animation: slideIn 0.3s ease;
}

.toast.error {
  background: linear-gradient(135deg,#c62828,#b71c1c);
}

@keyframes slideIn {
  from { transform: translateX(40px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* ================= SEARCH TABLE ================= */

.search-bar {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.search-bar input {
  flex: 1;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  background: var(--card);
  color: var(--text);
}

body.dark .search-bar input {
  border: 1px solid #374151;
}

.table-wrapper {
  overflow-x: auto;
}

.voucher-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.voucher-table th {
  text-align: left;
  padding: 10px;
  color: var(--muted);
  font-weight: 600;
  border-bottom: 1px solid #e5e7eb;
}

body.dark .voucher-table th {
  border-bottom: 1px solid #374151;
}

.voucher-table td {
  padding: 12px 10px;
  border-bottom: 1px solid #f1f5f9;
}

body.dark .voucher-table td {
  border-bottom: 1px solid #1f2937;
}

.voucher-table tr:hover {
  background: rgba(0,75,153,0.05);
}

.status-badge {
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-active {
  background: rgba(22,163,74,0.15);
  color: #15803d;
}

.status-used {
  background: rgba(37,99,235,0.15);
  color: #1d4ed8;
}

.status-cancelled {
  background: rgba(220,38,38,0.15);
  color: #b91c1c;
}

.action-btn {
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 11px;
  border: none;
  cursor: pointer;
  margin-right: 6px;
}

.redeem-btn {
  background: #16a34a;
  color: white;
}

.cancel-btn {
  background: #dc2626;
  color: white;
}
</style>
</head>

<body>

<!-- DARK MODE TOGGLE -->
<div class="toggle" onclick="toggleDark()">üåô / ‚òÄÔ∏è</div>

<div class="container">

  <!-- HEADER -->
  <div class="header-gradient">
    <a href="https://www.discoveryhike.in" target="_blank">
      <img src="https://i.imgur.com/40sl7Sv.png" alt="Discovery Hike Logo">
    </a>
    <h1>Discovery Hike ‚Äì Admin Portal</h1>
    <p>Internal operational tools ‚Ä¢ Authorized access only</p>
  </div>

 <!-- ================= VOUCHER SYSTEM ================= -->
<div class="section">
  <div class="section-title">Voucher Dashboard</div>

  <!-- KPI CARDS -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-title">Active</div>
      <div class="kpi-value" id="kpiActive">0</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-title">Used</div>
      <div class="kpi-value" id="kpiUsed">0</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-title">Cancelled</div>
      <div class="kpi-value" id="kpiCancelled">0</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-title">Expiring Soon</div>
      <div class="kpi-value" id="kpiExpiring">0</div>
    </div>
  </div>

  <!-- TAB NAVIGATION -->
  <div class="voucher-tabs">
    <div class="voucher-tab active" onclick="showVoucherTab('generate', event)">Generate</div>
    <div class="voucher-tab" onclick="showVoucherTab('search', event)">Search</div>
    <div class="voucher-tab" onclick="showVoucherTab('redeem', event)">Redeem</div>
    <div class="voucher-tab" onclick="showVoucherTab('cancel', event)">Cancel</div>
    <div class="voucher-tab" onclick="showVoucherTab('reminder', event)">Reminders</div>
  </div>

  <!-- PANELS -->
  <div id="generate" class="voucher-panel">
<form id="generateForm" class="voucher-form">

  <div class="form-row">
    <div class="form-group">
<input type="email" id="genEmail" required placeholder=" " />
      <label>Email Address</label>
    </div>

    <div class="form-group">
      <input type="text" id="genName" required placeholder=" " />
      <label>Client Name</label>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <input type="number" id="genAmount" required placeholder=" "  />
      <label>Voucher Amount (‚Çπ)</label>
    </div>

    <div class="form-group">
<input type="date" id="genExpiry" placeholder=" " />
      <label>Expiry Date (Optional)</label>
    </div>
  </div>

  <div class="form-group">
    <textarea id="genPurpose" rows="3"></textarea>
    <label>Purpose (Optional)</label>
  </div>

  <button type="submit" class="primary-btn" id="generateBtn">
    Generate Voucher
  </button>

</form>
<div id="toast" class="toast hidden"></div>
<div id="generateResult" class="result-box hidden"></div>  </div>

<div id="search" class="voucher-panel hidden">

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search by code, email, name..." />
  </div>

  <div class="table-wrapper">
    <table class="voucher-table">
      <thead>
        <tr>
          <th>Code</th>
          <th>Client</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Expiry</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="voucherTableBody">
        <tr>
          <td colspan="6" style="text-align:center; padding:20px;">
            No data loaded
          </td>
        </tr>
      </tbody>
    </table>
  </div>

</div>
  </div>

  <div id="redeem" class="voucher-panel hidden">
    Redeem UI will go here
  </div>

  <div id="cancel" class="voucher-panel hidden">
    Cancel UI will go here
  </div>

  <div id="reminder" class="voucher-panel hidden">
    Reminder UI will go here
  </div>

<!-- FOOTER -->
  <div class="footer">
    <div class="session-bar">
      <span id="sessionText">Secure admin session active</span>
      <button id="logoutBtn" class="logout-footer-btn">
        Logout
      </button>
    </div>

    <div style="margin-top:10px;">
      ¬© Discovery Hike ‚Ä¢ Internal Admin System
    </div>

    <p style="opacity:0.85;font-size:11px;line-height:1.4;margin-top:8px;">
      Internal admin system for Discovery Hike operations.<br>
      Access restricted to authorized staff only.
    </p>
  </div>

</div> <!-- CLOSE container -->




<script>

/* ================= FORCE LOGOUT SYNC ================= */
window.addEventListener('storage', (event) => {
  if (event.key === 'force-logout') {

    // Stop rendering immediately
    document.documentElement.innerHTML = '';

    // Hard redirect to logout endpoint
    window.location.replace("/cdn-cgi/access/logout");
  }
});


/* ================= PREVENT BF CACHE ================= */
window.addEventListener("pageshow", e => {
  if (e.persisted) location.reload();
});

/* ================= SHOW PAGE ================= */
document.body.style.visibility = "visible";

// ===== GET ADMIN EMAIL FROM CLOUDFLARE JWT =====
function getAdminEmailFromJWT() {
  const cookie = document.cookie
    .split("; ")
    .find(row => row.startsWith("CF_Authorization="));

  if (!cookie) return null;

  const token = cookie.split("=")[1];

  try {
    const payload = JSON.parse(atob(token.split(".")[1]));
    return payload.email || null;
  } catch {
    return null;
  }
}

const ADMIN_EMAIL = getAdminEmailFromJWT();

console.log("Voucher Page Admin:", ADMIN_EMAIL);
/* ================= DARK MODE ================= */
const storedTheme = localStorage.getItem("dh-theme");
if (storedTheme === "dark") document.body.classList.add("dark");

function toggleDark() {
  document.body.classList.toggle("dark");
  localStorage.setItem(
    "dh-theme",
    document.body.classList.contains("dark") ? "dark" : "light"
  );
}




/* ================= LOGOUT ================= */
document.getElementById("logoutBtn").addEventListener("click", function () {

  // Trigger other tabs
  localStorage.setItem('force-logout', Date.now());

  this.classList.add("loading");
  this.textContent = "Logging out‚Ä¶";

  window.location.href = "/cdn-cgi/access/logout";
});

let searchController;

function showVoucherTab(id, event) {
  document.querySelectorAll('.voucher-panel')
    .forEach(p => p.classList.add('hidden'));

  document.getElementById(id).classList.remove('hidden');

  document.querySelectorAll('.voucher-tab')
    .forEach(t => t.classList.remove('active'));

  event.target.classList.add('active');

  if (id === "search") {
    fetchVouchers(""); // Load latest 20
  }
}
const generateForm = document.getElementById("generateForm");
const generateBtn = document.getElementById("generateBtn");
const resultBox = document.getElementById("generateResult");

generateForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const email = document.getElementById("genEmail").value.trim();
  const client_name = document.getElementById("genName").value.trim();
  const amount = document.getElementById("genAmount").value.trim();
  const expiry_date = document.getElementById("genExpiry").value;
  const purpose = document.getElementById("genPurpose").value.trim();
const ADMIN_EMAIL = "admin@discoveryhike.in"; // temporary for now
  if (!email || !client_name || !amount) {
showToast("Please fill required fields.", true);
    return;
  }

  generateBtn.classList.add("loading");
  generateBtn.textContent = "Generating...";

  try {
    const response = await fetch(
  "https://evxkiwprlcxxfvzftttb.supabase.co/functions/v1/generate-voucher",
  {
    method: "POST",
    credentials: "include", // üî• REQUIRED
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
  email,
  client_name,
  amount,
  expiry_date,
  purpose,
  admin_email: ADMIN_EMAIL
})
  }
);
let data;

try {
  data = await response.json();
} catch {
  throw new Error("Invalid server response");
}
    if (!response.ok) throw new Error(data.error || "Error");

    resultBox.classList.remove("hidden");
    resultBox.innerHTML = `‚úÖ Voucher Created: <strong>${data.voucher_code}</strong>`;
showToast("Voucher created successfully!");
    generateForm.reset();

  } catch (err) {
showToast("Error: " + err.message, true);  }

  generateBtn.classList.remove("loading");
  generateBtn.textContent = "Generate Voucher";
});

function showToast(message, isError = false) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.classList.remove("hidden");
  toast.classList.toggle("error", isError);

  setTimeout(() => {
    toast.classList.add("hidden");
  }, 3000);
}


const searchInput = document.getElementById("searchInput");
let searchTimeout;

searchInput.addEventListener("input", () => {
  clearTimeout(searchTimeout);

  searchTimeout = setTimeout(() => {
    const value = searchInput.value.trim();

    if (value.length === 0 || value.length >= 2) {
      fetchVouchers(value);
    }
  }, 300);
});

const tableBody = document.getElementById("voucherTableBody");

async function fetchVouchers(query = "") {

  if (searchController) {
    searchController.abort();
  }

  searchController = new AbortController();

  tableBody.innerHTML =
    `<tr><td colspan="6" style="text-align:center;">Loading...</td></tr>`;

  try {
    const response = await fetch(
      "https://evxkiwprlcxxfvzftttb.supabase.co/functions/v1/search-voucher",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2eGtpd3BybGN4eGZ2emZ0dHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODIzMDIsImV4cCI6MjA4NzE1ODMwMn0.P0S9DIlKvECrzD83YcXuXDcL0dn5VDOdcrL3uKUvcIA",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2eGtpd3BybGN4eGZ2emZ0dHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODIzMDIsImV4cCI6MjA4NzE1ODMwMn0.P0S9DIlKvECrzD83YcXuXDcL0dn5VDOdcrL3uKUvcIA"
        },
        body: JSON.stringify({ query }),
        signal: searchController.signal
      }
    );
let data;

try {
  data = await response.json();
} catch {
  throw new Error("Invalid server response");
}

    if (!response.ok) {
      throw new Error(data.error || "Search failed");
    }

    renderTable(data.data || []);

  } catch (err) {
    if (err.name === "AbortError") return;

    tableBody.innerHTML =
      `<tr><td colspan="6" style="text-align:center; color:red;">
        ${err.message}
      </td></tr>`;
  }
}


function renderTable(vouchers) {
  if (!vouchers.length) {
    tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No results found</td></tr>`;
    return;
  }

  tableBody.innerHTML = vouchers.map(v => `
    <tr>
      <td><strong>${v.voucher_code}</strong></td>
      <td>${v.client_name}<br><small>${v.email}</small></td>
      <td>‚Çπ${v.amount}</td>
      <td>
        <span class="status-badge status-${v.status}">
          ${v.status}
        </span>
      </td>
      <td>${v.expiry_date || "-"}</td>
      <td>
        ${v.status === "active" ? `
          <button class="action-btn redeem-btn" onclick="quickRedeem('${v.voucher_code}')">
            Redeem
          </button>
          <button class="action-btn cancel-btn" onclick="quickCancel('${v.voucher_code}')">
            Cancel
          </button>
        ` : "-"}
      </td>
    </tr>
  `).join("");
}

async function quickRedeem(code) {
  if (!confirm("Redeem this voucher?")) return;

  try {
    const response = await fetch(
      "https://evxkiwprlcxxfvzftttb.supabase.co/functions/v1/redeem-voucher",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2eGtpd3BybGN4eGZ2emZ0dHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODIzMDIsImV4cCI6MjA4NzE1ODMwMn0.P0S9DIlKvECrzD83YcXuXDcL0dn5VDOdcrL3uKUvcIA",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2eGtpd3BybGN4eGZ2emZ0dHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODIzMDIsImV4cCI6MjA4NzE1ODMwMn0.P0S9DIlKvECrzD83YcXuXDcL0dn5VDOdcrL3uKUvcIA"
        },
        body: JSON.stringify({ voucher_code: code })
      }
    );

  let data;

try {
  data = await response.json();
} catch {
  throw new Error("Invalid server response");
}
    if (!response.ok) throw new Error(data.error || "Redeem failed");

    showToast("Voucher redeemed!");
    fetchVouchers(searchInput.value.trim());

  } catch (err) {
    showToast(err.message, true);
  }
}

async function quickCancel(code) {
  if (!confirm("Cancel this voucher?")) return;

  try {
    const response = await fetch(
      "https://evxkiwprlcxxfvzftttb.supabase.co/functions/v1/cancel-voucher",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2eGtpd3BybGN4eGZ2emZ0dHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODIzMDIsImV4cCI6MjA4NzE1ODMwMn0.P0S9DIlKvECrzD83YcXuXDcL0dn5VDOdcrL3uKUvcIA",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2eGtpd3BybGN4eGZ2emZ0dHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODIzMDIsImV4cCI6MjA4NzE1ODMwMn0.P0S9DIlKvECrzD83YcXuXDcL0dn5VDOdcrL3uKUvcIA"
        },
        body: JSON.stringify({ voucher_code: code })
      }
    );

  let data;

try {
  data = await response.json();
} catch {
  throw new Error("Invalid server response");
}
    if (!response.ok) throw new Error(data.error || "Cancel failed");

    showToast("Voucher cancelled!");
    fetchVouchers(searchInput.value.trim());

  } catch (err) {
    showToast(err.message, true);
  }
}

</script>


</body>
</html>








